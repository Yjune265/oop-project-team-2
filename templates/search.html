{% extends "base.html" %}
{% block title %}ì˜ì–‘ì œ ì°¾ê¸°{% endblock %}

{% block content %}
<style>
    /* ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
    .cat-btn {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    .cat-btn:hover {
        transform: translateY(-3px);
    }
    .cat-btn.active .icon-circle {
        background-color: #ffe4e6 !important; /* í™œì„±í™” ì‹œ í•‘í¬ìƒ‰ ë°°ê²½ */
        border: 2px solid #ff6b6b;
    }
    .icon-circle {
        width: 60px;
        height: 60px;
        font-size: 1.8rem;
        background-color: #f8f9fa;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 8px;
        transition: background-color 0.2s;
    }
    .cat-text {
        font-size: 0.85rem;
        color: #555;
        font-weight: 600;
        word-break: keep-all;
    }
</style>

<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        
        <div class="d-flex align-items-center mb-4 mt-2">
            <a href="javascript:history.back()" class="text-dark text-decoration-none me-3">
                <i class="bi bi-chevron-left" style="font-size: 1.2rem;">&lt;</i>
            </a>
            <h5 class="fw-bold mb-0">ì˜ì–‘ì œ ì°¾ê¸°</h5>
        </div>

        <div class="mb-5">
            <h6 class="fw-bold mb-3 ms-1">ê³ ë¯¼ë˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</h6>
            <div class="row row-cols-4 row-cols-sm-4 g-3 text-center" id="categoryGrid">
                </div>
        </div>
        
        <hr class="my-4 border-secondary opacity-10">

        <div class="position-relative mb-4">
            <span class="position-absolute top-50 start-0 translate-middle-y ms-3 text-muted">ğŸ”</span>
            <input type="text" id="searchInput" class="form-control bg-light border-0 py-3 ps-5 rounded-4" 
                   placeholder="í˜¹ì€ ì œí’ˆëª…ìœ¼ë¡œ ê²€ìƒ‰" onkeyup="if(window.event.keyCode==13){resetAndSearchText()}">
            <button class="btn btn-dark position-absolute top-50 end-0 translate-middle-y me-2 rounded-pill px-3 py-1" 
                    onclick="resetAndSearchText()">ê²€ìƒ‰</button>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0" id="resultTitle">ê²€ìƒ‰ ê²°ê³¼</h6>
            <span class="badge bg-light text-secondary rounded-pill" id="resultCount" style="display:none">0ê±´</span>
        </div>

        <div id="searchResult" class="vstack gap-3 mb-4">
             <div class="text-center text-muted py-5 small">
                 ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ì œí’ˆëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.
             </div>
        </div>

        <div class="text-center mb-5">
            <button id="loadMoreBtn" class="btn btn-outline-secondary rounded-pill px-4" 
                    style="display: none;" onclick="loadMore()">
                ë” ë³´ê¸° <i class="bi bi-chevron-down"></i>
            </button>
        </div>

    </div>
</div>

<script>
    // ì¹´í…Œê³ ë¦¬ ë°ì´í„° ì •ì˜ (ìš”ì²­í•˜ì‹  ë§¤í•‘ ê¸°ì¤€)
    const CATEGORIES = [
        { name: 'í”¼ë¡œ/í™œë ¥', icon: 'ğŸ’ª', keywords: 'í”¼ë¡œ/í™œë ¥' },
        { name: 'ê°„ ê±´ê°•', icon: 'ğŸº', keywords: 'ê°„ ê±´ê°•' },
        { name: 'ë‹¤ì´ì–´íŠ¸', icon: 'âš–ï¸', keywords: 'ë‹¤ì´ì–´íŠ¸/ì²´ì§€ë°©' },
        { name: 'í˜ˆê´€/ìˆœí™˜', icon: 'ğŸ©¸', keywords: 'í˜ˆì•¡ìˆœí™˜/ì½œë ˆìŠ¤í…Œë¡¤, í˜ˆì•• ê´€ë¦¬, í˜ˆë‹¹ ê´€ë¦¬' },
        { name: 'ëˆˆ ê±´ê°•', icon: 'ğŸ‘ï¸', keywords: 'ëˆˆ ê±´ê°•' },
        { name: 'ë¼ˆ/ê´€ì ˆ', icon: 'ğŸ¦´', keywords: 'ë¼ˆ/ê´€ì ˆ/ê·¼ìœ¡' },
        { name: 'ì† í¸í•œ/ì†Œí™”', icon: 'ğŸ˜Œ', keywords: 'ìœ„/ì†Œí™”, ì¥ ê±´ê°•/ë³€ë¹„' },
        { name: 'í”¼ë¶€/ë¯¸ìš©', icon: 'âœ¨', keywords: 'í”¼ë¶€, ëª¨ë°œ/ë‘í”¼/ì†í†±, í•­ë…¸í™”/í•­ì‚°í™”' },
        { name: 'ë©´ì—­ë ¥', icon: 'ğŸ›¡ï¸', keywords: 'ë©´ì—­ë ¥/ì•ŒëŸ¬ì§€' },
        { name: 'ìˆ˜ë©´/ìŠ¤íŠ¸ë ˆìŠ¤', icon: 'ğŸ˜´', keywords: 'ìˆ˜ë©´ ì§ˆ ê°œì„ , ìŠ¤íŠ¸ë ˆìŠ¤/ë§ˆìŒê±´ê°•, ê¸°ì–µë ¥/ì¸ì§€ë ¥' },
        { name: 'ì—¬ì„±', icon: 'ğŸ‘©', keywords: 'ì—¬ì„± ê±´ê°•/PMS, ì„ì‹ /ì„ì‹ ì¤€ë¹„' },
        { name: 'ë‚¨ì„±', icon: 'ğŸ‘¨', keywords: 'ë‚¨ì„± ê±´ê°•' }
    ];

    // ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
    let currentKeywords = '';
    let currentPage = 1;
    const itemsPerPage = 10;
    let isCategoryMode = false;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´í…Œê³ ë¦¬ ë²„íŠ¼ ìƒì„±
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('categoryGrid');
        CATEGORIES.forEach(cat => {
            grid.innerHTML += `
                <div class="col">
                    <div class="cat-btn" onclick="selectCategory(this, '${cat.name}', '${cat.keywords}')">
                        <div class="icon-circle shadow-sm">${cat.icon}</div>
                        <div class="cat-text">${cat.name}</div>
                    </div>
                </div>
            `;
        });
    });

    // 1. ì¹´í…Œê³ ë¦¬ ì„ íƒ í•¸ë“¤ëŸ¬
    function selectCategory(element, name, keywords) {
        // UI í™œì„±í™” ì²˜ë¦¬
        document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
        element.classList.add('active');

        // ìƒíƒœ ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ
        document.getElementById('searchInput').value = ''; // í…ìŠ¤íŠ¸ ê²€ìƒ‰ì°½ ë¹„ìš°ê¸°
        document.getElementById('resultTitle').innerText = `#${name}`;
        
        currentKeywords = keywords;
        currentPage = 1;
        isCategoryMode = true;
        
        document.getElementById('searchResult').innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”
        fetchProducts();
    }

    // 2. í…ìŠ¤íŠ¸ ê²€ìƒ‰ í•¸ë“¤ëŸ¬
    function resetAndSearchText() {
        const query = document.getElementById('searchInput').value;
        if(!query) {
            alert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”');
            return;
        }

        // ì¹´í…Œê³ ë¦¬ ì„ íƒ í•´ì œ
        document.querySelectorAll('.cat-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById('resultTitle').innerText = `'${query}' ê²€ìƒ‰ ê²°ê³¼`;

        currentKeywords = query;
        currentPage = 1;
        isCategoryMode = false;

        document.getElementById('searchResult').innerHTML = '';
        fetchProducts();
    }

    // 3. ë”ë³´ê¸° ë²„íŠ¼ í•¸ë“¤ëŸ¬
    function loadMore() {
        currentPage++;
        fetchProducts();
    }

    // 4. API ë°ì´í„° í˜¸ì¶œ (í•µì‹¬ ë¡œì§)
    async function fetchProducts() {
        const btn = document.getElementById('loadMoreBtn');
        const countSpan = document.getElementById('resultCount');
        
        try {
            // URL ìƒì„±: í˜ì´ì§€ë„¤ì´ì…˜ ì •ë³´(page, limit) í¬í•¨
            const url = `/api/supplement/category?q=${encodeURIComponent(currentKeywords)}&page=${currentPage}&limit=${itemsPerPage}`;
            
            const res = await fetch(url);
            const json = await res.json();
            
            if(json.status === 'success') {
                const results = json.results;
                
                // ê²°ê³¼ ê°œìˆ˜ í‘œì‹œ
                countSpan.style.display = 'inline-block';
                // (ì°¸ê³ : ì „ì²´ ê°œìˆ˜ë¥¼ APIê°€ ì£¼ë©´ ì¢‹ì§€ë§Œ, ì¼ë‹¨ í˜„ì¬ ë¡œë“œëœ ê²ƒ ê¸°ì¤€ ì˜ˆì‹œ)
                
                if (results.length === 0) {
                    if(currentPage === 1) {
                        document.getElementById('searchResult').innerHTML = '<div class="text-center p-5 text-muted">í•´ë‹¹í•˜ëŠ” ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    }
                    btn.style.display = 'none'; // ë” ì´ìƒ ë°ì´í„° ì—†ìŒ
                    return;
                }

                // ì¹´ë“œ ë Œë”ë§
                const list = document.getElementById('searchResult');
                results.forEach(prod => {
                    list.innerHTML += `
                        <div class="card border-0 shadow-sm p-3 rounded-4 mb-2" onclick="location.href='/supplement/detail/${prod.id}'" style="cursor:pointer">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded-3 d-flex align-items-center justify-content-center me-3 text-secondary" style="width: 60px; height: 60px; font-size:1.5rem;">
                                    ğŸ’Š
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <h6 class="fw-bold mb-1 text-truncate" style="max-width: 180px;">${prod.name}</h6>
                                        <span class="badge bg-primary bg-opacity-10 text-primary border-0 fw-normal">ì •ë³´ë³´ê¸°</span>
                                    </div>
                                    <small class="text-muted d-block">${prod.company || 'ì œì¡°ì‚¬ ì •ë³´ ì—†ìŒ'}</small>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // ë”ë³´ê¸° ë²„íŠ¼ ì²˜ë¦¬: ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ limitë³´ë‹¤ ì ìœ¼ë©´ ëë‚œ ê²ƒì„
                if (results.length < itemsPerPage) {
                    btn.style.display = 'none';
                } else {
                    btn.style.display = 'inline-block';
                }

            } else {
                alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        } catch(e) {
            console.error(e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
        }
    }
</script>
{% endblock %}